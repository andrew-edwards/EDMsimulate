---
title: "salmon_sim"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{salmon_sim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  fig.width = 6
)
```

Different ways to simulate data, and to fit it, and to do multiple simulations
with different stochasticity or assumptions/scenarios. Haven't yet decided on
exact terminology.
The notation in the code matches that in the write up of the second manuscript (in the `edm-work` repository).

```{r setup}
# load_all()          # use this for local up-to-date testing
library(EDMsimulate)
library(pbsEDM)      # https://github.com/pbs-assess/pbsEDM
```

## To run a simulation
```{r}
sim_data <- salmon_sim()
sim_data
```

##  Simple plot of resulting time series of spawners
```{r}
plot_sim(sim_data)
```

## To run and plot in one go
```{r}
salmon_run()
```

See `?salmon_sim` for settings to change the default parameters and initial
conditions for the simulations.

## To do bifurcation diagrams

See code in `salmon_bif.R`, not needed here yet.

## To fit using pbsEDM

Basing on example analysis in pbsEDM vignette `analyse_simple_time_series.Rmd`.

```{r fit1}
sim_fit <- pbsEDM::pbsEDM(sim_data,
                          lags = list(R_prime_t = 0,     # can test
                                        # others. Biologically defendible assumptions
                                      S_t = 0:3),
                          first_difference = TRUE)    # can try both
sim_fit$results
```

Try a deterministic simulation, and then again using the new `sim_and_fit()`
wrapper:
```{r function}
sim_data_determ <- salmon_sim(deterministic = TRUE)

sim_fit_determ_fit <- pbsEDM::pbsEDM(sim_data_determ,
                          lags = list(R_prime_t = 0,     # can test
                                        # others. Biologically defendible assumptions
                                      S_t = 0:3),
                          first_difference = TRUE)    # can try both

# Then in one function
sim_fit_determ_fit_2 <- sim_and_fit(salmon_sim_args = list(deterministic =
                                                             TRUE),
                                    pbsEDM_args = list(lags = list(R_prime_t = 0,
                                                                   S_t = 0:3),
                                                       first_difference = TRUE))

# These should match:
sim_fit_determ_fit$results
sim_fit_determ_fit_2$fit$results
expect_equal(sim_fit_determ_fit$results,
             sim_fit_determ_fit_2$fit$results)
```

## To run multiple realisations using the same parameter values but differing in stochasticity

Does this work? Thinking of using the term `realisations` specifically for multiple runs that
have the same parameters but only differ in the resulting process noise
(i.e. just different due to stochasticity).

We said `scenarios` for the specific assumptions on
the proportions that we talked about last week (there'd just be three
scenarios). So changing other parameters could fall under the broader `simulations`.




Could call these `realisations`, and save `simulations` for different
assumptions (parameter values), and `scenarios` for the specific assumptions on
the proportions.


It kind of helps be consistent when giving names to functions, though I realise
I've already used `sim` quite a lot. Maybe the `realisation` one is the useful
distinction.
