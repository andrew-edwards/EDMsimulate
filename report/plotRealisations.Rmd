---
title: "plotRealisations"
author: "Carrie Holt"
date: "2023-07-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Plot realisations

This code runs the sim_and_fit_realisations over numerous trials and extracts the forecasts

```{r runRealisations}
library(EDMsimulate)
library(dplyr)
library(ggplot2)
library(larkin)
library(parallel)
library(tidyr)
library(RColorBrewer)

# Run using stan-optim for Larkin model to speed up model runs
# See larkin-compareMLE-Bayes.Rmd for a comparison
# larkin_args() and ricker_args() have default values, but if one element 
# changes, the entire list needs to be included here

# List of elements for running function separately
# salmon_sim_args <- list(sigma_nu = 1, omega = 0.4)
# target_hr <- 0.2
# sigma_ou <- 0.05
# edm_fit <-  TRUE
# larkin_fit <-  TRUE
# ricker_fit <-  TRUE
# R_switch <-  "R_t"#R_prime_t"#"R_t"#
# pbsEDM_args <- list(lags = list(R_switch = 0,
# 															 S_t = 0:3),
# 									 first_difference = TRUE,
# 									 centre_and_scale = TRUE)
# larkin_args = list( run_stan = FALSE,
# 										prior_mean_alpha = 2,
# 										prior_mean_beta = -rep(1,4),
# 										prior_mean_sigma = 0.5,
# 										prior_sd_alpha = 0.5,
# 										prior_sd_beta = rep(0.25,4),
# 										prior_sd_sigma = 0.25)
# ricker_args <- list(run_stan = FALSE,
# 									 prior_mean_alpha = 2,
# 									 prior_mean_beta = -1,
# 									 prior_mean_sigma = 0.5,
# 									 prior_sd_alpha = 0.5,
# 									 prior_sd_beta = 0.25,
# 									 prior_sd_sigma = 0.25)
# M <-  10

out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 1, 
																						 			 omega = 0.4), 
																						 target_hr = 0.2,
																						 sigma_ou = 0.05,
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 R_switch = "R_t",#"R_prime_t",#"R_t",#
																						 M = 100)
```
Then plot outputs.

```{r plotForecasts}

# Extract forecasts and forecast errors
results_bc <- forecast_errors(out, label="base_case")

# Plot forecasts against true (simulated) values
p1 <- results_bc$forecasts %>% 
	ggplot(aes(x=R_sim, y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1

# Plot distribution of absolute errors in forecast
p2 <- results_bc$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```
The above example assumes returns are the variable being predictd. Another option is recruitment (by brood year), which is the more direct predictor of Larkin model. The simulation is repeated with recruitment, and EDM forecasts are (tentatively) less biased (why?)

```{r}
out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 1, 
																						 			 omega = 0.4), 
																						 target_hr = 0.2,
																						 sigma_ou = 0.05,
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 R_switch = "R_prime_t",#"R_t",#
																						  M = 100)

# Extract forecasts and forecast errors
results_rec <- forecast_errors(out, label="recruits")
# Plot forecasts against true (simulated) values
p1 <- results_rec$forecasts %>% 
	ggplot(aes(x=R_sim, y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1

# Plot distribution of absolute errors in forecast
p2 <- results_rec$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```


The Larkin and Ricker models tend to have absolute errors in forecast that are closer to zero, compared with EDM.

The simulation is then repeated, but with altered beta parameters where beta0 is dominant over the remaining beta parameters (more similar to a Ricker model).

```{r Beta0}
out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 1, 
																						 			 omega = 0.4,
																						 			 beta = c(0.45, 0.25, 0.15, 0.15)), 
																						 target_hr = 0.2,
																						 sigma_ou = 0.05,
																						 R_switch = "R_t",#"R_prime_t",#"R_t",#
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 M = 100)

# Extract forecasts and forecast errors
results_ric <- forecast_errors(out, label="ricker")

p1 <- results_ric$forecasts %>% 
	ggplot(aes(x=R_sim, y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1
p2 <- results_ric$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```

Simulations were then run with low process variation (sigma_nu=0.1)

```{r}
out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 0.1, 
																						 			 omega = 0.4), 
																						 target_hr = 0.2,
																						 sigma_ou = 0.05,
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 R_switch = "R_t",#"R_t",#
																						 M = 100)

# Extract forecasts and forecast errors
results_sigma_nu_0.1 <- forecast_errors(out, label="sigma_nu_0.1")


# Plot forecasts against true (simulated) values
p1 <- results_sigma_nu_0.1$forecasts %>%
	ggplot(aes(x=R_sim, y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1

# Plot distribution of absolute errors in forecast
p2 <- results_sigma_nu_0.1$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```

Simulations were then run including temporal variabilty in productivity (Larkin alpha parameter), with a trends similar to those observed historically for Fraser River Sockeye salmon (Pestal et al. in review; Huang et al. 2020 [Fraser Sockeye RPA]). Three patterns in temporal variability in productivity are evident in the historical time-series: (1) stable productivity throughout most of the time-series with the exception of declines in the most recent generation (e.g., Nadina, Seymour, Gates, Upper Pitt River, Scotch, Chilko, Late Shuswap) , (2) gradual declines starting in the 1970s (e.g.,Upper Barriere, Portage, Early Stuart, Bowron), and (3) relatively stable productivity in early time-series until 1990 followed by steeper declines (e.g., Weaver Creek, Raft, Birkenhead, Stellako, Quesnel, Late Stuart, Weaver Creek). 

```{r alphaTrends}

# Fraser Sockeye time-series run 1950-2016 BY, so 1970 is T minus 46 (or year 34 in 80 year time-series) and 1990 is T minus 26 (or year 54 in 80 year time-series)
alpha1 <- c(rep(exp(2), 100), rep(exp(2), 76), seq(exp(2), exp(1.75), length.out=4))
alpha2 <- c(rep(exp(2), 100), rep(exp(2), 34), seq(exp(2), exp(0.5), length.out=46))
alpha3 <- c(rep(exp(2), 100), rep(exp(2), 54), seq(exp(2), exp(0.5), length.out=26))
alpha4 <- c(rep(exp(2), 100), rep(exp(2), 34), rep(exp(0.5),46))
df <- data.frame(year = rep(1:180,4), 
								 productivity = c(alpha1, alpha2, alpha3, alpha4), 
								 trend=c(rep(1,180), rep(2, 180), rep(3,180), rep(4,180)))

p1 <- df |> ggplot2::ggplot(aes(x=year, y=productivity, colour=as.factor(trend))) + geom_line()
p1

```

These trends were then included in the simulation runs
```{r simRunAlphaTrends}


out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(alpha = alpha2,
																						 			 sigma_nu = 1, 
																						 			 omega = 0.4), 
																							target_hr = 0.2,
																						  sigma_ou = 0.05,
																							R_switch = "R_t",#"R_prime_t",#"R_t",#
																							larkin_fit = TRUE,
																							ricker_fit = TRUE,
																							M = 100)

# Extract forecasts and forecast errors
results_alpha_decline <- forecast_errors(out, label = "alpha_decline")


p1 <- results_alpha_decline$forecasts %>%
	ggplot(aes(x=R_sim, y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1
p2 <- results_alpha_decline$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```

And repeated with low process variation and alpha decline. 
```{r}

out <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(alpha = alpha2,
																						 			 sigma_nu = 0.1, 
																						 			 omega = 0.4), 
																							target_hr = 0.2,
																						  sigma_ou = 0.05,
																							R_switch = "R_t",#"R_prime_t",#"R_t",#
																							larkin_fit = TRUE,
																							ricker_fit = TRUE,
																							M = 100)

# Extract forecasts and forecast errors
results_alpha_decline_sigma_nu_0.1 <- forecast_errors(out, label = "alpha_decline_sigma_nu_0.1")


p1 <- results_alpha_decline_sigma_nu_0.1$forecasts %>%
	ggplot(aes(x=R_sim,  y=R_fit, colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1
p2 <- results_alpha_decline_sigma_nu_0.1$absErr %>% 
	ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2


```

