---
title: "plotRealisations"
author: "Carrie Holt"
date: "2023-07-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Plot realisations

This code runs the sim_and_fit_realisations over numerous trials and extracts the forecasts

```{r runRealisations}

library(dplyr)
library(ggplot2)
library(larkin)
library(RColorBrewer)

# Run using stan-optim for Larkin model to speed up model runs
# See larkin-compareMLE-Bayes.Rmd for a comparison
# larkin_args() and ricker_args() have default values, but if one element 
# changes, the entire list needs to be included here

# # List of elements for running function separately
# salmon_sim_args <- list(sigma_nu = 1, omega = 0.4)
# edm_fit <-  TRUE
# larkin_fit <-  TRUE
# ricker_fit <-  TRUE
# R_switch <-  "R_prime_t"#"R_t"#
# pbsEDM_args <- list(lags = list(R_switch = 0,
# 															 S_t = 0:3),
# 									 first_difference = TRUE,
# 									 centre_and_scale = TRUE)
# larkin_args = list( run_stan = FALSE,
# 										prior_mean_alpha = 2,
# 										prior_mean_beta = -rep(1,4),
# 										prior_mean_sigma = 0.5,
# 										prior_sd_alpha = 0.5,
# 										prior_sd_beta = rep(0.25,4),
# 										prior_sd_sigma = 0.25)
# ricker_args <- list(run_stan = FALSE,
# 									 prior_mean_alpha = 2,
# 									 prior_mean_beta = -1,
# 									 prior_mean_sigma = 0.5,
# 									 prior_sd_alpha = 0.5,
# 									 prior_sd_beta = 0.25,
# 									 prior_sd_sigma = 0.25)
# M <-  10

run <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 1, 
																						 			 omega = 0.4), 
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 R_switch = "R_t",#"R_prime_t",#"R_t",#
																						 larkin_args = list(
																						 	run_stan = FALSE,
																						  prior_mean_alpha = 2,
																						  prior_mean_beta = -rep(1,4),
																						  prior_mean_sigma = 0.5,
																						  prior_sd_alpha = 0.5,
																						  prior_sd_beta = rep(0.25,4),
																						  prior_sd_sigma = 0.25),
																						 ricker_args = list(
																						 	run_stan = FALSE,
																						 	prior_mean_alpha = 2,
																						 	prior_mean_beta = -1,
																						 	prior_mean_sigma = 0.5,
																						 	prior_sd_alpha = 0.5,
																						 	prior_sd_beta = 0.25,
																						 	prior_sd_sigma = 0.25),
																						 M = 10)
```
Then plot outputs.

```{r plotForecasts}
# Get results for either R_prime (recruitment) or R_ (returns)
if(names(run$res_realisations)[2]=="R_prime_T_sim"){
	res_realisations_plot <- run$res_realisations %>% 
		dplyr::rename( R_sim = R_prime_T_sim) %>% 
		dplyr::rename( R_edm = R_prime_T_edm_fit) %>% 
		dplyr::rename( R_lar = R_prime_T_lar_fit) %>% 
		dplyr::rename( R_ric = R_prime_T_ric_fit)
}
if(names(run$res_realisations)[2]=="R_T_sim"){
	res_realisations_plot <- run$res_realisations %>% 
		dplyr::rename( R_sim = R_T_sim) %>% 
		dplyr::rename( R_edm = R_T_edm_fit) %>% 
		dplyr::rename( R_lar = R_T_lar_fit) %>% 
		dplyr::rename( R_ric = R_T_ric_fit)
}

# Calculate absolute error in forecast for EDM, Larkin and Ricker
run.out <- res_realisations_plot %>% dplyr::mutate(absErr_edm = 
														 	(R_edm - R_sim), 
														 absErr_lar = 
														 	(R_lar - R_sim),
														 absErr_ric = 
														 	(R_ric - R_sim))

# Pivot absolute errors into a long table for plotting with ggplot
absErr <- tidyr::pivot_longer(run.out, c(absErr_edm, absErr_lar, absErr_ric), 
																names_to="forMethod", 
																names_prefix = "absErr_", 
																values_to="absErr")
absErr <- absErr %>% select(m,forMethod, absErr)

# Pivot forecasted estimates into a long table for plotting with ggplot
forecast_data <- tidyr::pivot_longer(run.out, c(R_edm, 
																						R_lar,
																						R_ric), 
															names_to="forMethod", 
															names_prefix = "R_", 
															values_to="R_fit") 
forecast_data <- forecast_data %>% 
	dplyr::select(m,forMethod, R_fit, R_sim)

# Plot forecasts against true (simulated) values
p1 <- forecast_data %>% ggplot(aes(x=R_sim, 
																	 y=R_fit, 
																	 colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p1

# Plot distribution of absolute errors in forecast
p2 <- absErr %>% ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p2

```
The Larkin and Ricker models tend to have absolute errors in forecast that are closer to zero, compared with EDM.

The simulation is then repeated, but with altered beta parameters where beta0 is dominant over the remaining beta parameters (more similar to a Ricker model).

```{r Beta0}
run2 <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(sigma_nu = 1, 
																						 			 omega = 0.4,
																						 			 beta = c(0.45, 0.25, 0.15, 0.15)), 
																						 larkin_fit = TRUE,
																						 ricker_fit = TRUE,
																						 larkin_args = list(
																						 	run_stan = FALSE,
																						  prior_mean_alpha = 2,
																						  prior_mean_beta = -rep(1,4),
																						  prior_mean_sigma = 0.5,
																						  prior_sd_alpha = 0.5,
																						  prior_sd_beta = rep(0.25,4),
																						  prior_sd_sigma = 0.25),
																						 ricker_args = list(
																						 	run_stan = FALSE,
																						 	prior_mean_alpha = 2,
																						 	prior_mean_beta = -1,
																						 	prior_mean_sigma = 0.5,
																						 	prior_sd_alpha = 0.5,
																						 	prior_sd_beta = 0.25,
																						 	prior_sd_sigma = 0.25),
																						 M = 100)


run2 <- run2 %>% dplyr::mutate(absErr_edm = 
														 	(R_prime_T_edm_fit - R_prime_T_sim), 
														 absErr_lar = 
														 	(R_prime_T_lar_fit - R_prime_T_sim),
														 absErr_ric = 
														 	(R_prime_T_ric_fit - R_prime_T_sim))

absErr2 <- tidyr::pivot_longer(run2, c(absErr_edm, absErr_lar, absErr_ric), 
																names_to="forMethod", 
																names_prefix = "absErr_", 
																values_to="absErr")
absErr2 <- absErr2 %>% select(m,forMethod, absErr)

forecast_data2 <- tidyr::pivot_longer(run2, c(R_prime_T_edm_fit, 
																						R_prime_T_lar_fit,
																						R_prime_T_ric_fit), 
															names_to="forMethod", 
															names_prefix = "R_prime_T_", 
															values_to="R_prime_T_fit") 
forecast_data2 <- forecast_data2 %>% 
	select(m,forMethod, R_prime_T_fit, R_prime_T_sim)

p3 <- forecast_data2 %>% ggplot(aes(x=R_prime_T_sim, 
																	 y=R_prime_T_fit, 
																	 colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p3
p4 <- absErr2 %>% ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p4

```

Simulations were then run including temporal variabilty in productivity (Larkin alpha parameter), with a trends similar to those observed historically for Fraser River Sockeye salmon (Pestal et al. in review; Huang et al. 2020 [Fraser Sockeye RPA]). Three patterns in temporal variability in productivity are evident in the historical time-series: (1) stable productivity throughout most of the time-series with the exception of declines in the most recent generation (e.g., Nadina, Seymour, Gates, Upper Pitt River, Scotch, Chilko, Late Shuswap) , (2) gradual declines starting in the 1970s (e.g.,Upper Barriere, Portage, Early Stuart, Bowron), and (3) relatively stable productivity in early time-series until 1990 followed by steeper declines (e.g., Weaver Creek, Raft, Birkenhead, Stellako, Quesnel, Late Stuart, Weaver Creek). 

```{r alphaTrends}

# Fraser Sockeye time-series run 1950-2016 BY, so 1970 is T minus 46 (or year 34 in 80 year time-series) and 1990 is T minus 26 (or year 54 in 80 year time-series)
alpha1 <- c(rep(exp(2), 100), rep(exp(2), 76), seq(exp(2), exp(1.75), length.out=4))
alpha2 <- c(rep(exp(2), 100), rep(exp(2), 34), seq(exp(2), exp(0.5), length.out=46))
alpha3 <- c(rep(exp(2), 100), rep(exp(2), 54), seq(exp(2), exp(0.5), length.out=26))
df <- data.frame(year = rep(1:180,3), 
								 productivity = c(alpha1, alpha2, alpha3), 
								 trend=c(rep(1,180), rep(2, 180), rep(3,180)))

p1 <- df |> ggplot2::ggplot(aes(x=year, y=productivity, colour=as.factor(trend))) + geom_line()
# p1

```

These trends were included in the simulation runs
```{r simRunAlphaTrends}

run3 <- EDMsimulate::sim_and_fit_realisations(salmon_sim_args = 
																						 	list(alpha = alpha3,
																						 			 sigma_nu = 1, 
																						 			 omega = 0.4,
																						 			 beta = c(0.45, 0.25, 0.15, 0.15)), 
																							larkin_fit = TRUE,
																							ricker_fit = TRUE,
																							larkin_args = list(
																						 	run_stan = FALSE,
																						  prior_mean_alpha = 2,
																						  prior_mean_beta = -rep(1,4),
																						  prior_mean_sigma = 0.5,
																						  prior_sd_alpha = 0.5,
																						  prior_sd_beta = rep(0.25,4),
																						  prior_sd_sigma = 0.25),
																						 ricker_args = list(
																						 	run_stan = FALSE,
																						 	prior_mean_alpha = 2,
																						 	prior_mean_beta = -1,
																						 	prior_mean_sigma = 0.5,
																						 	prior_sd_alpha = 0.5,
																						 	prior_sd_beta = 0.25,
																						 	prior_sd_sigma = 0.25),
																						 M = 50)


run3 <- run3 %>% dplyr::mutate(absErr_edm = 
														 	(R_prime_T_edm_fit - R_prime_T_sim), 
														 absErr_lar = 
														 	(R_prime_T_lar_fit - R_prime_T_sim),
														 absErr_ric = 
														 	(R_prime_T_ric_fit - R_prime_T_sim))

absErr3 <- tidyr::pivot_longer(run3, c(absErr_edm, absErr_lar, absErr_ric), 
																names_to="forMethod", 
																names_prefix = "absErr_", 
																values_to="absErr")
absErr3 <- absErr3 %>% select(m,forMethod, absErr)

forecast_data3 <- tidyr::pivot_longer(run3, c(R_prime_T_edm_fit, 
																						R_prime_T_lar_fit,
																						R_prime_T_ric_fit), 
															names_to="forMethod", 
															names_prefix = "R_prime_T_", 
															values_to="R_prime_T_fit") 
forecast_data3 <- forecast_data3 %>% 
	select(m,forMethod, R_prime_T_fit, R_prime_T_sim)

p4 <- forecast_data3 %>% ggplot(aes(x=R_prime_T_sim, 
																	 y=R_prime_T_fit, 
																	 colour=forMethod)) + 
	geom_point() + 
	geom_smooth(method='lm', formula= y~x) + 
	xlab("Simulated 'true' recruitment") + 
	ylab("Forecasted recruitment") +
	geom_abline(slope=1, intercept = 0, col="dark grey")
p4
p5 <- absErr3 %>% ggplot(aes(x=absErr, colour=forMethod)) + 
	geom_density() +
	xlab("Absolute error in forecast") +
	ylab("Density")
p5

```

